# 同時実行制御について説明できる


## 1. 同時実行制御

トランザクションの重要な役割の一つに、同時実行制御(排他制御)があります。

同時実行制御とは何か、何のためにあるものかを、データベース初心者にわかるように説明してください。

A. 
1つのデータベースに対して複数の操作が同時に行われたときに行う制御のことです。
トランザクションの前と後でデータの整合性を保つ役割があります。


## 2. ACID 特性

トランザクションが必要とする特性に、ACID 特性があります。ACID 特性について、データベース初心者にわかるように説明してください。

A. 
- Atomicity（原子性） 一連の処理が全部成功するか失敗するかを保証する仕組みです。commitかrollbackのどちらかを必ず最後に行います。
- Consistency（一貫性） トランザクションの実行前後でDBの状態が不整合や矛盾がないように保つことです。
- Isolation（独立性） トランザクションが複数のユーザから同時に行われる際にそれぞれの処理が矛盾なく行われることです。例えば、ロックをかけて処理が同時に行われないようにします。
- Durability（耐久性）コミットが完了すると保存され結果が失われなくなります。異常が発生してデータが失われても復旧できる手段を持ちます。

## 3. ロック

同時実行制御を行うための主要な方法がロックです。ロックとは何か、どのようにして同時実行制御を実現するかを、データベース初心者にわかるように説明してください。

A.　ロックには排他ロックと共有ロックがあります。排他ロック中は自分以外のユーザーがロック対象に読み込みも書き込みもできない状態です。
共有ロックは自分も他のユーザーも含めて読み込みのみが可能になります。書き込みは不可です。
排他ロックを使用することで一人ずつしか更新処理が行えなくなるので同時実行制御が実現されます。

## 4. ロックの確認

ロックの挙動を確認しましょう。

ターミナルを2つ開き、両方とも employees データベースに接続してください。

片方のターミナル（ターミナル1）で、トランザクションを開始してください。給与テーブルに対して、従業員番号が10001で、開始日が1986-06-26の従業員の給与を70000に更新してください。

A. 
```sql
START TRANSACTION;
UPDATE salaries
   SET salary = 70000
 WHERE emp_no = 10001 AND from_date = '1986-06-26';
```

もう片方のターミナル（ターミナル2）で、給与テーブルに対して、従業員番号が10001で、開始日が1986-06-26の従業員の給与を2倍に更新してください。こちらのターミナルはクエリを実行されたまま停止することを確認してください。

A.
```sql
UPDATE salaries
   SET salary = salary * 2
 WHERE emp_no = 10001 AND from_date = '1986-06-26';
 ```

ターミナル1で、従業員番号が10001で、開始日が1986-06-26の従業員の給与を検索してください。給与が70000のままロックされていることを確認しましょう。

A.
```sql
SELECT salary
  FROM salaries
 WHERE emp_no = 10001 AND from_date = '1986-06-26';
```

ターミナル1で、コミットをします。

```sql
COMMIT;
```

ターミナル2を開いてください。クエリが実行されているはずです。ターミナル2から従業員番号が10001で、開始日が1986-06-26の従業員の給与を検索してください。給与が2倍に更新されているはずです。

これがロックの基本の挙動です。他にもクエリを色々試してみて、ロックの挙動を確認してみてください。

